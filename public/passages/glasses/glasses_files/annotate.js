(function(){var NewselaAnnotator,async,delay,bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;async=function(f){return setTimeout(f,0)},delay=function(milliseconds,f){return setTimeout(f,milliseconds)},jQuery.fn.cursorin=function(){return this.each(function(){return $(this).focus().select()})},NewselaAnnotator=function(superClass){function NewselaAnnotator(element,options){this.clearSelection=bind(this.clearSelection,this),this.showEditor=bind(this.showEditor,this),this.showViewer=bind(this.showViewer,this),this.startViewerHideTimer=bind(this.startViewerHideTimer,this),this.onHighlightMouseover=bind(this.onHighlightMouseover,this),this.promoteCurrentSelection=bind(this.promoteCurrentSelection,this),this.isRangeDisallowed=bind(this.isRangeDisallowed,this),this.checkForEndSelection=bind(this.checkForEndSelection,this),this.checkForStartSelection=bind(this.checkForStartSelection,this);var ref;this.options=$.extend({},this.DEFAULT_OPTIONS,options),NewselaAnnotator.__super__.constructor.apply(this,arguments),this.addPlugin("Touch",{container:"#data-lane"}),this.addPlugin("NewselaViewer",{container:"#data-lane",user:this.options.user,responding_enabled:this.options.responding_enabled}),this.options.user&&this.addPlugin("NewselaStore",{article_id:this.options.article_id,student_id:this.options.student_id,user:this.options.user,user_id_filters:null!=(ref=this.options.user_id_filters)?ref:[]}),this.addPlugin("NewselaDiscovery",{user:this.options.user,article_id:this.options.article_id,userIsInTestGroup:this.options.userIsInTestGroup,teacherHasStudents:this.options.teacherHasStudents,isProUser:this.options.isProUser}),options.readOnly&&$(document).on("mousedown",function(_this){return function(){return _this.publish("selectionRemoved")}}(this))}return extend(NewselaAnnotator,superClass),NewselaAnnotator.prototype.DEFAULT_OPTIONS={article_id:null,responding_enabled:!0,student_id:null,user:null,user_id_filters:[]},NewselaAnnotator.prototype.checkForStartSelection=function(e){return NewselaAnnotator.__super__.checkForStartSelection.apply(this,arguments)},NewselaAnnotator.prototype.checkForEndSelection=function(e){var i,len,range,ref;try{NewselaAnnotator.__super__.checkForEndSelection.apply(this,arguments)}catch(error){return}for(ref=this.selectedRanges,i=0,len=ref.length;i<len;i++)if(range=ref[i],this.isAnnotator(range.commonAncestor)||this.isRangeDisallowed(range))return this.publish("selectionRemoved"),!0;return this.selectedRanges.length&&!/^\s*$/.test(this.selectedRanges[0].text())?this.publish("selectionCreated",[this.selectedRanges]):this.publish("selectionRemoved")},NewselaAnnotator.prototype.isRangeDisallowed=function(range){var range_contents;return range_contents=range.toRange().cloneContents(),null!==range_contents.querySelector(".annotator-disallow")},NewselaAnnotator.prototype.setupAnnotation=function(annotation){var e,i,j,len,len1,normed,normedRanges,r,ref,root;for(root=this.wrapper[0],annotation.ranges||(annotation.ranges=this.selectedRanges),normedRanges=[],ref=annotation.ranges,i=0,len=ref.length;i<len;i++){r=ref[i];try{normedRanges.push(Annotator.Range.sniff(r).normalize(root))}catch(error){if(e=error,!(e instanceof Annotator.Range.RangeError))throw e;this.publish("rangeNormalizeFail",[annotation,r,e])}}for(annotation.quote=[],annotation.ranges=[],annotation.highlights=[],j=0,len1=normedRanges.length;j<len1;j++)normed=normedRanges[j],annotation.quote.push($.trim(normed.text())),annotation.ranges.push(normed.serialize(this.wrapper[0],".annotator-hl, .annotator-ignore")),$.merge(annotation.highlights,this.highlightRange(normed));return annotation.quote=annotation.quote.join(" / "),$(annotation.highlights).data("annotation",annotation),$(annotation.highlights).attr("data-annotation-id",annotation.id),annotation.pen_name&&!annotation.in_response_to&&$(annotation.highlights).addClass(annotation.pen_name),this.showViewer([annotation]),annotation},NewselaAnnotator.prototype.promoteCurrentSelection=function($annotation){var $question,annotation;return annotation=this.setupAnnotation(this.createAnnotation()),annotation.category="user",annotation.article={id:Number($("#Article").attr("data-id"))||this.options.article_id},annotation.user=this.options.user,$question=$("#Quiz.docked .questions .QuizQuestion[data-id].active"),$question.length&&(annotation.quiz_question_open_id=Number($question.attr("data-id"))),$annotation.data({annotation:annotation}),annotation.$annotation=$annotation,this.clearSelection(),$(annotation.highlights).addClass("editable"),annotation},NewselaAnnotator.prototype.onHighlightMouseover=function(e){var annotation;if(annotation=$(e.target).data("annotation"))return $(annotation.highlights).addClass("hovering")},NewselaAnnotator.prototype.startViewerHideTimer=function(){return this.element.find(".annotator-hl.hovering").removeClass("hovering")},NewselaAnnotator.prototype.showViewer=function(annotations,mouse_position){return null},NewselaAnnotator.prototype.showEditor=function(){return null},NewselaAnnotator.prototype.clearSelection=function(){var ref,selection;return selection=null!=(ref="function"==typeof window.getSelection?window.getSelection():void 0)?ref:document.selection,"function"==typeof selection.empty&&selection.empty(),"function"==typeof selection.removeAllRanges?selection.removeAllRanges():void 0},NewselaAnnotator}(Annotator),Annotator.Plugin.NewselaDiscovery=function(superClass){function NewselaDiscovery(element,options){this.dismissSampleButton=bind(this.dismissSampleButton,this),this.veil_track_event=bind(this.veil_track_event,this),this.veilTourEvent=bind(this.veilTourEvent,this),this.annotationDiscoveryVeil=bind(this.annotationDiscoveryVeil,this),this.loadSampleAnnotation=bind(this.loadSampleAnnotation,this),this.buildSampleAnnotations=bind(this.buildSampleAnnotations,this),this.determineSampleText=bind(this.determineSampleText,this),this.userShouldSeeVeil=bind(this.userShouldSeeVeil,this),this.userShouldSeeDiscovery=bind(this.userShouldSeeDiscovery,this),this.pluginInit=bind(this.pluginInit,this),NewselaDiscovery.__super__.constructor.apply(this,arguments)}return extend(NewselaDiscovery,superClass),NewselaDiscovery.prototype.events={annotationUpdated:"annotationDiscoveryVeil"},NewselaDiscovery.prototype.pluginInit=function(){var tracker_data;return this.userShouldSeeDiscovery()?(this.loadSampleAnnotation(),tracker_data={event_name:"annotation_discovery_sample",event_type:"view",properties:{article_id:this.options.article_id}},"undefined"!=typeof tracker&&null!==tracker?tracker.track_user_event(tracker_data):void 0):null},NewselaDiscovery.prototype.userShouldSeeDiscovery=function(){var is_discovery_tour_finished,is_read_tour_finished,ref,ref1,ref2,ref3,ref4,ref5,ref6,ref7,ref8,tour_events;return tour_events=null!=(ref=null!=(ref1=this.options.user)?ref1.tour_events:void 0)?ref:{},is_read_tour_finished=(null!=(ref2=this.options.user)?ref2.is_school_educator:void 0)&&"complete"===(null!=(ref3=tour_events["read-page-tour"])?ref3.step:void 0)||(null!=(ref4=tour_events["read-page-tour"])?ref4.is_skipped:void 0),is_discovery_tour_finished=null!=tour_events.annotation_discovery&&("complete"===(null!=(ref5=tour_events.annotation_discovery)?ref5.step:void 0)||(null!=(ref6=tour_events.annotation_discovery)?ref6.is_skipped:void 0)),!!this.options.userIsInTestGroup&&(!this.options.user||!is_discovery_tour_finished&&(!((null!=(ref7=this.options.user)?ref7.is_school_educator:void 0)&&!is_read_tour_finished)&&((null!=(ref8=this.options.user)?ref8.is_school_educator:void 0)&&is_read_tour_finished,!0)))},NewselaDiscovery.prototype.userShouldSeeVeil=function(){var is_veil_tour_finished,ref,ref1,ref2,ref3,ref4,tour_events;return tour_events=null!=(ref=null!=(ref1=this.options.user)?ref1.tour_events:void 0)?ref:{},is_veil_tour_finished="complete"===(null!=(ref2=tour_events.annotation_veil)?ref2.step:void 0)||(null!=(ref3=tour_events.annotation_veil)?ref3.is_skipped:void 0),!is_veil_tour_finished&&(!(null==(ref4=this.options.user)||!ref4.is_school_educator)&&((!this.options.teacherHasStudents||!this.options.isProUser)&&(!(this.options.teacherHasStudents||!this.options.isProUser)||(!(!this.options.teacherHasStudents||this.options.isProUser)||(!this.options.isProUser||void 0)))))},NewselaDiscovery.prototype.determineSampleText=function(){var is_pro_teacher_with_class_and_students,ref,ref1;return is_pro_teacher_with_class_and_students=(null!=(ref=this.options.user)?ref.is_school_educator:void 0)&&this.options.isProUser&&this.options.teacherHasStudents,!(null!=(ref1=this.options.user)?ref1.is_school_educator:void 0)&&this.options.isProUser?"Type here to make an annotation and start a conversation with your teacher. For a new annotation, highlight any text.":is_pro_teacher_with_class_and_students?"Type here to make an annotation and start a conversation with your students. For a new annotation, highlight any text.":"Type here to make an annotation. For a new annotation, highlight any text."},NewselaDiscovery.prototype.buildSampleAnnotations=function(){var after_30_chars,first_paragraph_text,index_of_annotation,next_period_index,sample;return first_paragraph_text=this.element.find("p").first().text(),first_paragraph_text.length?(after_30_chars=first_paragraph_text.substring(30),next_period_index=after_30_chars.indexOf("."),index_of_annotation=next_period_index===-1?first_paragraph_text.length-1:30+next_period_index,sample={category:"sample",endoffset:index_of_annotation+1,copied_from_id:null,end:"/p[1]",text:this.determineSampleText(),dismissed:!1,pen_name:"blue",date_archived:null,start:"/p[1]",user:this.options.user,startoffset:0},sample.ranges=[{start:sample.start,startOffset:sample.startoffset,end:sample.end,endOffset:sample.endoffset}],[sample]):[]},NewselaDiscovery.prototype.loadSampleAnnotation=function(){return this.annotator.loadAnnotations(this.buildSampleAnnotations()),this.dismissSampleButton()},NewselaDiscovery.prototype.annotationDiscoveryVeil=function(annotation){var $alreadyVeil,$annotationEditor,annotationId,is_pro_teacher_with_no_students,ref,ref1,trackerData;if($alreadyVeil=$(".annotation-discovery-veil"),annotationId=annotation.id,is_pro_teacher_with_no_students=(null!=(ref=this.options.user)?ref.is_school_educator:void 0)&&this.options.isProUser&&!this.options.teacherHasStudents,0===$alreadyVeil.length&&this.userShouldSeeVeil())return $annotationEditor=$(".Annotation[data-id="+annotationId+"]").parent(),$("<div />").addClass("annotation-discovery-veil").appendTo($annotationEditor).append('<i class="fa fa-times dismiss-discovery-veil" aria-hidden="true"></i>').append('<div class="veil-text"></div>'),(null!=(ref1=this.options.user)?ref1.is_school_educator:void 0)&&!this.options.isProUser?$(".veil-text").append("<span>Share this with your class with </span>").append($("<a>Newsela Pro</a>").attr({href:"/about-pro/?utm_source=web&utm_campaign=nav_settings_dropdown",target:"_blank","class":"veil-link"})):is_pro_teacher_with_no_students&&$(".veil-text").append($("<a>Add students </a>").attr({href:"/settings/#/classrooms/",target:"_blank","class":"veil-link"})).append("<span>and share these annotations with your class.</span>"),$(".dismiss-discovery-veil").on("click",function(_this){return function(){return _this.veilTourEvent(1,!0),_this.veil_track_event("annotation_discovery_veil_dismiss")}}(this)),$(".veil-link").on("click",function(_this){return function(){return _this.veilTourEvent("complete",!1),_this.veil_track_event("annotation_discovery_veil")}}(this)),trackerData={event_name:"annotation_discovery_veil",event_type:"view",properties:{article_id:annotation.article_id}},"undefined"!=typeof tracker&&null!==tracker?tracker.track_user_event(trackerData):void 0},NewselaDiscovery.prototype.veilTourEvent=function(step,skipped){var user_id;return user_id=this.options.user.id,$.ajax({type:"POST",url:window.API_BASE_URL+"/tour-event/",contentType:"application/json",data:JSON.stringify({user_id:user_id,step:step,is_skipped:skipped,name:"annotation_veil"})}),$(".annotation-discovery-veil").remove()},NewselaDiscovery.prototype.veil_track_event=function(name){var trackerData;return trackerData={event_name:name,event_type:"click",properties:{article_id:this.options.article_id}},"undefined"!=typeof tracker&&null!==tracker?tracker.track_user_event(trackerData):void 0},NewselaDiscovery.prototype.dismissSampleButton=function(){return $(".discovery-sample .annotation-help-bar").append('<i class="fa fa-times dismiss-discovery" aria-hidden="true"></i>'),$(".discovery-sample textarea").on("focusin",function(_this){return function(e){var trackerData;return trackerData={event_name:"annotation_discovery_sample",event_type:"focusin"},"undefined"!=typeof tracker&&null!==tracker?tracker.track_user_event(trackerData):void 0}}(this))},NewselaDiscovery}(Annotator.Plugin),Annotator.Plugin.NewselaViewer=function(superClass){function NewselaViewer(element,options){this.annotationIsSample=bind(this.annotationIsSample,this),this.annotationIsOwner=bind(this.annotationIsOwner,this),this.annotationIsEditable=bind(this.annotationIsEditable,this),this.annotationIsEmpty=bind(this.annotationIsEmpty,this),this.getAnnotationXOffset=bind(this.getAnnotationXOffset,this),this.getAnnotationYOffset=bind(this.getAnnotationYOffset,this),this.getRangeYOffset=bind(this.getRangeYOffset,this),this.repositionAnnotations=bind(this.repositionAnnotations,this),this.createBucketAtOffset=bind(this.createBucketAtOffset,this),this.getRangeContainer=bind(this.getRangeContainer,this),this.getAnnotationContainer=bind(this.getAnnotationContainer,this),this.bringToFore=bind(this.bringToFore,this),this.dismissAnnotation=bind(this.dismissAnnotation,this),this.hideAnnotation=bind(this.hideAnnotation,this),this.hideEditor=bind(this.hideEditor,this),this.showAnnotation=bind(this.showAnnotation,this),this.getAnnotationElement=bind(this.getAnnotationElement,this),this.editAnnotation=bind(this.editAnnotation,this),this.editAnnotationElement=bind(this.editAnnotationElement,this),this.editRange=bind(this.editRange,this),this.constructAnnotationElement=bind(this.constructAnnotationElement,this),this.selectPen=bind(this.selectPen,this),this.dismissEditor=bind(this.dismissEditor,this),this.onWindowResize=bind(this.onWindowResize,this),this.selectionRemoved=bind(this.selectionRemoved,this),this.selectionCreated=bind(this.selectionCreated,this),this.annotationsLoaded=bind(this.annotationsLoaded,this),this.onHighlightMouseout=bind(this.onHighlightMouseout,this),this.onHighlightMouseover=bind(this.onHighlightMouseover,this),this.onHighlightClick=bind(this.onHighlightClick,this),this.onHighlightTap=bind(this.onHighlightTap,this),this.annotationUpdated=bind(this.annotationUpdated,this),this.getMultipleAnnotationsForHighlight=bind(this.getMultipleAnnotationsForHighlight,this),this.getOneAnnotationForHighlight=bind(this.getOneAnnotationForHighlight,this),this.pluginInit=bind(this.pluginInit,this),NewselaViewer.__super__.constructor.apply(this,arguments),this.container=$(options.container).toggleClass("anonymous-user",!options.user),this.last_pen_name_selected=null,$(window).on("resize",function(_this){return function(){return _this.onWindowResize()}}(this)),$(window).on("load",function(_this){return function(){return _this.onWindowResize()}}(this)),$(window).on("reinitializeAnnotationPosition",function(_this){return function(){return _this.onWindowResize()}}(this)),$("article figure img").on("load",function(_this){return function(){return _this.onWindowResize()}}(this))}return extend(NewselaViewer,superClass),NewselaViewer.prototype.events={annotationsLoaded:"annotationsLoaded",selectionCreated:"selectionCreated",selectionRemoved:"selectionRemoved",onHighlightTap:"onHighlightTap",".annotator-hl click":"onHighlightClick",".annotator-hl mouseover":"onHighlightMouseover",".annotator-hl mouseout":"onHighlightMouseout",annotationUpdated:"annotationUpdated"},NewselaViewer.prototype.options={bucketClass:"annotation-viewer-bucket",user:null},NewselaViewer.prototype.pluginInit=function(){return null},NewselaViewer.prototype.getOneAnnotationForHighlight=function(highlight){return $(highlight).data("annotation")},NewselaViewer.prototype.getMultipleAnnotationsForHighlight=function(highlight){return $(highlight).parents(".annotator-hl").andSelf().map(function(){return $(this).data("annotation")})},NewselaViewer.prototype.annotationUpdated=function(annotation){return null},NewselaViewer.prototype.onHighlightTap=function(e){return this.onHighlightClick(e)},NewselaViewer.prototype.onHighlightClick=function(e){var annotation;return annotation=this.getOneAnnotationForHighlight(e.target),this.annotationIsEditable(annotation)&&(this.editAnnotation(annotation),this.getAnnotationElement(annotation).find("textarea[name=text]").focus()),e.stopPropagation()},NewselaViewer.prototype.onHighlightMouseover=function(e){var $annotation,$highlight,annotation;if($highlight=$(e.target),annotation=$highlight.data("annotation"))return $annotation=this.getAnnotationElement(annotation).addClass("hovering"),this.container.is(".editing")||this.bringToFore(annotation),this.container.addClass("hovering")},NewselaViewer.prototype.onHighlightMouseout=function(e){var $highlight,annotation;if($highlight=$(e.target),annotation=$highlight.data("annotation"))return this.getAnnotationElement(annotation).removeClass("hovering"),this.container.removeClass("hovering")},NewselaViewer.prototype.annotationsLoaded=function(annotations){var annotation,display_date,display_name,hash_annotation_id,i,j,len,len1,ref;for(annotations.sort(function(a,b){return a.date_created.localeCompare(b.date_created)}),i=0,len=annotations.length;i<len;i++)annotation=annotations[i],annotation.in_response_to||(annotation.text&&this.showAnnotation(annotation),this.annotationIsEditable(annotation)&&$(annotation.highlights).addClass("editable"),this.annotationIsOwner(annotation)||(display_name=this.getAnnotationDisplayName(annotation),display_date=moment(annotation.date_created).fromNow(),$(annotation.highlights).attr("title",display_name+", "+display_date)));for(j=0,len1=annotations.length;j<len1;j++)annotation=annotations[j],annotation.in_response_to&&this.showAnnotation(annotation);if(hash_annotation_id=null!=(ref=location.hash.match("#/annotations/(\\d+)/?"))?ref[1]:void 0)return delay(500,function(){var $annotation,top;return $annotation=$(".Annotation[data-id="+hash_annotation_id+"]"),top=$annotation.offset().top,$("html, body").animate({scrollTop:top-100}),$annotation.addClass("highlighted"),delay(2e3,function(){return $annotation.removeClass("highlighted")})})},NewselaViewer.prototype.selectionCreated=function(ranges){var range;return range=ranges[0],this.hideEditor(),this.editRange(range),this.repositionAnnotations()},NewselaViewer.prototype.selectionRemoved=function(ranges){return this.hideEditor()},NewselaViewer.prototype.onWindowResize=function(e){return null!=this.pid&&clearTimeout(this.pid),this.pid=delay(100,function(_this){return function(){return _this.repositionAnnotations(!0)}}(this))},NewselaViewer.prototype.dismissEditor=function(e){return this.container.find("#data-lane textarea[name=text].editing").trigger("focusout").trigger("blur"),this.hideEditor(),e.preventDefault()},NewselaViewer.prototype.selectPen=function(annotation,$annotation,pen_name){var ref;return null==annotation&&(annotation=this.annotator.promoteCurrentSelection($annotation),this.repositionAnnotations()),pen_name||(pen_name=null!=(ref=this.last_pen_name_selected)?ref:$annotation.find(".pen").eq(0).attr("data-pen-name")),annotation.pen_name!==pen_name&&($(annotation.highlights).removeClass(annotation.pen_name).addClass(pen_name),$annotation.attr({"data-pen-name":pen_name}),annotation.pen_name=pen_name,this.last_pen_name_selected=pen_name,this.annotator.updateAnnotation(annotation)),annotation},NewselaViewer.prototype.constructAnnotationElement=function(annotation){var $annotation,autosave_pid,i,len,range,ref,ref1,ref2,ref3,reply_to_display_name;if(null==annotation&&(annotation=null),autosave_pid=null,$annotation=$("#annotation-editor-template .Annotation").clone(),$annotation.on("mousedown",".pen",function(_this){return function(e){var $pen,pen_name;if(null==annotation||!annotation.in_response_to)return $pen=$(e.target),pen_name=$pen.attr("data-pen-name"),annotation=_this.selectPen(annotation,$annotation,pen_name),e.preventDefault(),e.stopPropagation()}}(this)).on("click",".share, .widget-publish",function(_this){return function(e){return annotation=_this.selectPen(annotation,$annotation),$annotation.addClass("shared"),annotation.date_shared=new Date,_this.annotator.updateAnnotation(annotation),e.preventDefault(),e.stopPropagation()}}(this)).on("click",".unshare, .widget-unpublish",function(_this){return function(e){return $annotation.removeClass("shared"),annotation.date_shared=null,_this.annotator.updateAnnotation(annotation),e.preventDefault(),e.stopPropagation()}}(this)).on("click",".dismiss-discovery",function(_this){return function(e){var trackerData;return $annotation.remove(),_this.hideEditor(),_this.annotator.clearSelection(),_this.annotator.deleteAnnotation(annotation),$.ajax({type:"POST",url:window.API_BASE_URL+"/tour-event/",contentType:"application/json",data:JSON.stringify({user_id:_this.options.user.id,step:1,is_skipped:!0,name:"annotation_discovery"})}),trackerData={event_name:"annotation_discovery_sample_dismiss",event_type:"click",properties:{article_id:annotation.article_id}},"undefined"!=typeof tracker&&null!==tracker?tracker.track_user_event(trackerData):void 0}}(this)).on("click",".delete, .delete-icon, .widget-discard",function(_this){return function(e){return annotation?(_this.annotator.deleteAnnotation(annotation),delete annotation.href,delete annotation.id,_this.hideEditor({deleted:!0})):(_this.hideEditor(),_this.annotator.clearSelection()),$annotation.removeClass("editable").removeClass("displayName").removeClass("saved").addClass("deleted").attr({"data-id":""}),e.preventDefault(),e.stopPropagation()}}(this)).on("click",".undelete",function(_this){return function(e){return $annotation.remove(),_this.annotator.setupAnnotation(annotation),_this.annotator.updateAnnotation(annotation),_this.showAnnotation(annotation),$(annotation.highlights).addClass("editable"),_this.repositionAnnotations(),e.preventDefault(),e.stopPropagation()}}(this)).on("focusin","textarea[name=text]",function(_this){return function(e){return $annotation.is(".editable:not(.editing)")&&_this.editAnnotationElement($annotation),_this.annotationIsSample(annotation)&&$(".discovery-sample textarea").select(),(null!=annotation?annotation.pen_name:void 0)||(null!=annotation?annotation.in_response_to:void 0)||(annotation=_this.selectPen(annotation,$annotation)),e.stopPropagation()}}(this)).on("click",".save-close-editor",function(_this){return function(e){var $annotation_editior,$textarea;return $annotation_editior=$(e.target).parent(),$textarea=$annotation_editior.find("textarea"),$textarea.trigger("focusout").trigger("blur"),$annotation_editior.removeClass("editing"),e.preventDefault()}}(this)).on("focusout",">textarea[name=text]",function(_this){return function(e){var $textarea,text;return e.stopPropagation(),$textarea=$(e.target),text=$.trim($textarea.val()),$textarea.val(text).trigger("autosize.resize"),$annotation.is(".response")&&!text?(_this.annotator.deleteAnnotation(annotation),_this.hideEditor({deleted:!0})):annotation.text!==text?(annotation.text=text,_this.annotator.updateAnnotation(annotation)):void 0}}(this)).on("keyup","textarea[name=text]",function(_this){return function(e){return e.stopPropagation()}}(this)).on("keydown","textarea[name=text]",function(_this){return function(e){var $textarea,text;return e.stopPropagation(),$textarea=$(e.target),e.ctrlKey&&13===e.keyCode?($textarea.trigger("focusout").trigger("blur"),void e.preventDefault()):(text=$.trim($textarea.val()),annotation.text!==text?(annotation.text=text,$annotation.toggleClass("has-text",!!text),autosave_pid&&clearTimeout(autosave_pid),autosave_pid=delay(400,function(){return _this.annotator.updateAnnotation(annotation),_this.repositionAnnotations()})):void 0)}}(this)).on("click",".respond",function(_this){return function(e){var $response,response;return e.preventDefault(),e.stopPropagation(),response={article:annotation.article,in_response_to:annotation,ranges:annotation.ranges,user:_this.options.user},response=_this.annotator.setupAnnotation(response),$response=_this.showAnnotation(response),$response.addClass("creating response"),_this.editAnnotationElement($response),$response.find("textarea[name=text]").eq(0).focus().select()}}(this)).on("mouseup mousedown",function(_this){return function(e){return e.stopPropagation()}}(this)).on("mouseenter",function(_this){return function(e){return _this.container.addClass("hovering"),$annotation.addClass("hovering"),$(null!=annotation?annotation.highlights:void 0).addClass("hovering")}}(this)).on("mouseleave",function(_this){return function(e){return _this.container.removeClass("hovering"),$annotation.removeClass("hovering"),$(null!=annotation?annotation.highlights:void 0).removeClass("hovering")}}(this)).on("click",".annotation-help-bar .fa-question-circle",function(_this){return function(e){var trackerData;return trackerData={event_name:"annotation_help_bar",event_type:"click"},"undefined"!=typeof tracker&&null!==tracker?tracker.track_user_event(trackerData):void 0}}(this)),annotation){if($annotation.attr({"data-pen-name":annotation.pen_name}).toggleClass("discovery-sample",this.annotationIsSample(annotation)).toggleClass("response",!!annotation.in_response_to).toggleClass("editable",this.annotationIsEditable(annotation)).toggleClass("has-text",!!annotation.text).toggleClass("can-respond",!this.annotationIsOwner(annotation)&&!!annotation.text&&this.options.responding_enabled).toggleClass("shared",!!annotation.date_shared).ival(annotation),$annotation.find(".display_name").text(this.getAnnotationDisplayName(annotation)).attr({title:"posted "+moment(annotation.date_created).fromNow()}),0===annotation.ranges.length)for(annotation.ranges=[{start:annotation.start,startOffset:annotation.startoffset,end:annotation.end,endOffset:annotation.endoffset}],ref=annotation.ranges,i=0,len=ref.length;i<len;i++)range=ref[i],annotation.quote.push($.trim(range.text())),annotation.ranges.push(range.serialize(this.wrapper[0],".annotator-hl, .annotator-ignore")),$.merge(annotation.highlights,this.highlightRange(range));$annotation.data({annotation:annotation}),annotation.$annotation=$annotation}else this.options.user&&$annotation.find(".display_name").text(this.options.user.first_name+" "+this.options.user.last_name);return((null!=(ref1=this.options.user)?ref1.teacher:void 0)||(null!=(ref2=App.model.user)?ref2.teacher_id:void 0))&&annotation&&!this.annotationIsOwner(annotation)&&(reply_to_display_name=null!=(ref3=annotation.user.first_name)?ref3.toUpperCase():void 0,$annotation.find(".respond .caption").text("REPLY TO "+reply_to_display_name)),$annotation.find("textarea[name=text]").autosize({callback:function(_this){return function(){return _this.repositionAnnotations()}}(this),append:""}).prop("readonly",annotation&&!this.annotationIsEditable(annotation)),$annotation},NewselaViewer.prototype.editRange=function(range){var $annotation,$textarea;return $annotation=this.constructAnnotationElement().addClass("editable editing").toggleClass("creating",!!this.options.user).prependTo(this.getRangeContainer(range)),$textarea=$annotation.find("textarea[name=text]").trigger("autosize.resize"),$annotation.closest(".annotation-viewer-bucket").addClass("editing"),this.container.addClass("editing")},NewselaViewer.prototype.editAnnotationElement=function($annotation){var ref;return this.hideEditor(),$annotation.addClass("editing"),$annotation.closest(".annotation-viewer-bucket").addClass("editing"),$(null!=(ref=$annotation.data("annotation"))?ref.highlights:void 0).addClass("editing"),this.container.addClass("editing"),this.repositionAnnotations()},NewselaViewer.prototype.editAnnotation=function(annotation){var $annotation;return $annotation=this.showAnnotation(annotation),this.editAnnotationElement($annotation),$(annotation.highlights).addClass("editing")},NewselaViewer.prototype.getAnnotationElement=function(arg){var $annotation,id,is_in_dom;return id=arg.id,$annotation=arg.$annotation,$annotation=$annotation||this.container.find(".Annotation[data-id="+id+"]"),is_in_dom=$.contains(document.documentElement,$annotation[0]),is_in_dom?$annotation:$([])},NewselaViewer.prototype.showAnnotation=function(annotation){var $annotation,$parent,parent_id;return $annotation=this.getAnnotationElement(annotation),0===$annotation.length&&($annotation=this.constructAnnotationElement(annotation),annotation.in_response_to?(parent_id=annotation.in_response_to.id,$parent=this.getAnnotationElement({id:parent_id}),$parent.find(".responses:first").append($annotation),$parent.addClass("responded-to")):$annotation.appendTo(this.getAnnotationContainer(annotation))),$annotation.toggleClass("pro-teaser",!!annotation.is_pro_teaser),$annotation.find("textarea[name=text]").trigger("autosize.resize"),$annotation},NewselaViewer.prototype.hideEditor=function(arg){var deleted,reposition_necessary;if(deleted=(null!=arg?arg:{}).deleted,reposition_necessary=!1,this.container.find(".Annotation.editing").each(function(){var $annotation,annotation,should_remove_from_dom;return $annotation=$(this),$annotation.removeClass("editing"),$annotation.closest(".annotation-viewer-bucket").removeClass("editing"),should_remove_from_dom=deleted||$annotation.is(".creating")||!$.trim($annotation.find(":input[name=text]").val()),should_remove_from_dom&&($annotation.parents(".Annotation").first().removeClass("responded-to"),annotation=$annotation.data("annotation"),null!=annotation&&delete annotation.$annotation,$annotation.hide(),async(function(){return $annotation.remove()})),reposition_necessary=!0}),$(this.annotator.element).find(".annotator-hl.editing").removeClass("editing"),this.container.removeClass("editing"),reposition_necessary)return this.repositionAnnotations(!0)},NewselaViewer.prototype.hideAnnotation=function(annotation){var hl;return this.getAnnotationElement(annotation).remove(),hl=annotation.highlights[0],$(hl).replaceWith(hl.childNodes)},NewselaViewer.prototype.dismissAnnotation=function(annotation){var api_base;if(this.hideAnnotation(annotation),annotation.dismissed=!0,annotation.id)return api_base=window.API_BASE_URL,$.ajax({type:"PUT",url:api_base+"/annotation-dismissal/"+annotation.id+"/"})},NewselaViewer.prototype.destroy=function(){return NewselaViewer.__super__.destroy.apply(this,arguments),this.container.empty()},NewselaViewer.prototype.bringToFore=function(annotation){return this.container.find(".annotation-viewer-bucket").removeClass("in-foreground"),this.getAnnotationElement(annotation).closest(".annotation-viewer-bucket").addClass("in-foreground")},NewselaViewer.prototype.getAnnotationContainer=function(annotation){var $bucket,y;return y=this.getAnnotationYOffset(annotation),$bucket=this.createBucketAtOffset(y)},NewselaViewer.prototype.getRangeContainer=function(range){var y;return y=this.getRangeYOffset(range),this.createBucketAtOffset(y)},NewselaViewer.prototype.createBucketAtOffset=function(y){return $("<div />").addClass(this.options.bucketClass).attr({"data-offset":y}).css({position:"absolute",top:y}).appendTo(this.container)},NewselaViewer.prototype.repositionAnnotations=function(reset){var $buckets,a,a_mid,avg_height,bottom,buckets,distance,element_bottom,element_margin_bottom,i,items,iterations,j,k,len,len1,len2,max_bottom,n,n_mid,overlap,total_change;for(null==reset&&(reset=!1),$buckets=this.container.find(".annotation-viewer-bucket"),
$buckets.filter(function(){return 0===$(this).children().length}).remove(),buckets=$.map($buckets,function(_this){return function(el){var $annotation,$bucket,annotation,height,target,y;return $bucket=$(el),height=$bucket.outerHeight(!0),$annotation=$bucket.find(".Annotation").eq(0),annotation=$annotation.data("annotation"),target=(null!=annotation?annotation.id:void 0)||"sample"===(null!=annotation?annotation.category:void 0)?_this.getAnnotationYOffset(annotation):$bucket.position().top,y=reset?target:$bucket.position().top,{height:height,y:y,target:target,change:0,$bucket:$bucket,locked:$bucket.is(".editing")}}}(this)),total_change=2,iterations=0;total_change>1&&iterations<150;){for(items=buckets.slice(0),total_change=0,iterations+=1;items.length;)for(a=items.pop(),a_mid=a.y+a.height/2,i=0,len=items.length;i<len;i++)n=items[i],n!==a&&(n_mid=n.y+n.height/2,distance=Math.abs(n_mid-a_mid),avg_height=(n.height+a.height)/2,overlap=avg_height-distance,overlap>0&&(n.target>a.target&&(overlap=-overlap),a.locked?n.change-=overlap:n.locked?a.change+=overlap:(n.change-=overlap/2,a.change+=overlap/2),total_change+=Math.abs(overlap)));for(j=0,len1=buckets.length;j<len1;j++)a=buckets[j],a.y+=a.change,a.change=0}for(max_bottom=0,k=0,len2=buckets.length;k<len2;k++)a=buckets[k],a.$bucket.css({top:Math.floor(a.y)+"px"}),bottom=a.$bucket.position().top+a.$bucket.outerHeight(!0),max_bottom=Math.max(bottom,max_bottom);return element_bottom=this.element.position().top+this.element.outerHeight(),element_margin_bottom=Math.max(0,max_bottom-element_bottom),this.element.css({"margin-bottom":element_margin_bottom+"px"})},NewselaViewer.prototype.getRangeYOffset=function(range){var $test_span,backup_range,selection,y;return selection=window.getSelection(),backup_range=range.toRange(),$test_span=$("<span />").insertBefore(range.start),y=$test_span.position().top,$test_span.remove(),selection.removeAllRanges(),selection.addRange(backup_range),y},NewselaViewer.prototype.getAnnotationYOffset=function(annotation){var highlight,parent,y_offset;if(y_offset=0,annotation.highlights.length>=1)for(highlight=$(annotation.highlights).get(0),y_offset=highlight.offsetTop,parent=highlight.offsetParent;parent&&"ARTICLE"!==parent.tagName;)y_offset+=parent.offsetTop,parent=parent.offsetParent;return y_offset},NewselaViewer.prototype.getAnnotationXOffset=function(annotation){return $(annotation.highlights).first().position().left},NewselaViewer.prototype.annotationIsEmpty=function(annotation){return!(annotation.text||annotation.pen_name)},NewselaViewer.prototype.annotationIsEditable=function(annotation,user){return null==user&&(user=this.options.user),this.annotationIsOwner(annotation,user)},NewselaViewer.prototype.annotationIsOwner=function(annotation,user){var ref;return null==user&&(user=this.options.user),(null!=(ref=annotation.user)?ref.id:void 0)===(null!=user?user.id:void 0)},NewselaViewer.prototype.annotationIsSample=function(annotation){return"sample"===(null!=annotation?annotation.category:void 0)},NewselaViewer.prototype.getAnnotationDisplayName=function(annotation){var user;return user=annotation.user,$.trim((null!=user?user.first_name:void 0)+" "+(null!=user?user.last_name:void 0))},NewselaViewer}(Annotator.Plugin),Annotator.Plugin.NewselaStore=function(superClass){function NewselaStore(element,options){this.annotationUpdated=bind(this.annotationUpdated,this),this.annotationDeleted=bind(this.annotationDeleted,this),this.licenseAcquired=bind(this.licenseAcquired,this),this.loadAnnotations=bind(this.loadAnnotations,this),this._modelToAnnotation=bind(this._modelToAnnotation,this),this._annotationToModel=bind(this._annotationToModel,this),NewselaStore.__super__.constructor.apply(this,arguments)}return extend(NewselaStore,superClass),NewselaStore.prototype.API_ROOT=window.API_BASE_URL,NewselaStore.prototype.events={annotationCreated:"annotationCreated",annotationDeleted:"annotationDeleted",annotationUpdated:"annotationUpdated",licenseAcquired:"licenseAcquired"},NewselaStore.prototype.options={article_id:null,student_id:null,user:null,user_id_filters:[]},NewselaStore.prototype.pluginInit=function(){return this.loadAnnotations()},NewselaStore.prototype._annotationToModel=function(annotation){var model;return model={id:annotation.id,start:annotation.ranges[0].start,startoffset:annotation.ranges[0].startOffset,end:annotation.ranges[0].end,endoffset:annotation.ranges[0].endOffset,pen_name:annotation.pen_name,date_shared:annotation.date_shared,text:annotation.text,article_id:this.options.article_id,article:annotation.article,quiz_question_open:annotation.quiz_question_open,copied_from_id:annotation.copied_from_id,category:annotation.category},annotation.in_response_to&&(model.in_response_to=this._annotationToModel(annotation.in_response_to)),model},NewselaStore.prototype._modelToAnnotation=function(model){var annotation;return annotation=$.extend({},model,{ranges:[{start:model.start,startOffset:model.startoffset,end:model.end,endOffset:model.endoffset}]}),annotation.in_response_to&&(annotation.in_response_to=this._modelToAnnotation(annotation.in_response_to)),annotation},NewselaStore.prototype.loadAnnotations=function(){var data;return data={article_id:this.options.article_id},this.options.user_id_filters.length&&(data.user__in=this.options.user_id_filters.join(",")),this.options.student_id&&(data.student_id=this.options.student_id),$.ajax({type:"GET",url:this.API_ROOT+"/annotation/",data:data,success:function(_this){return function(response){var annotation_ids,annotations,copied_ids,model,parent_annotation_exists,repositionAnnotationsEvent;return copied_ids=function(){var i,len,results;for(results=[],i=0,len=response.length;i<len;i++)model=response[i],results.push(model.copied_from_id);return results}(),annotation_ids=function(){var i,len,results;for(results=[],i=0,len=response.length;i<len;i++)model=response[i],results.push(model.id);return results}(),parent_annotation_exists=function(model){return!model.in_response_to||annotation_ids.some(function(id){return id===model.in_response_to.id})},annotations=function(){var i,len,results;for(results=[],i=0,len=response.length;i<len;i++)model=response[i],parent_annotation_exists(model)&&results.push(this._modelToAnnotation(model));return results}.call(_this),_this.annotator.loadAnnotations(annotations),repositionAnnotationsEvent=document.createEvent("Event"),repositionAnnotationsEvent.initEvent("reinitializeAnnotationPosition",!0,!0),window.dispatchEvent(repositionAnnotationsEvent)}}(this)})},NewselaStore.prototype.licenseAcquired=function(license){return this.loadAnnotations()},NewselaStore.prototype.annotationDeleted=function(annotation){if(annotation.href)return $.ajax({type:"DELETE",url:annotation.href})},NewselaStore.prototype.annotationUpdated=function(annotation){var method,ref,ref1,ref2,url;return annotation.locked?void(annotation.is_modified=!0):(annotation.text&&(null!=(ref=annotation.$annotation)&&ref.addClass("saving"),null!=(ref1=annotation.$annotation)&&ref1.find(".saved").text("Saving..."),null!=(ref2=annotation.$annotation)&&ref2.find(".save-close-editor").text("SAVED")),annotation.locked=!0,annotation.href?(method="PUT",url=annotation.href):(method="POST",url=this.API_ROOT+"/annotation/"),"sample"===annotation.category&&(annotation.category="user",annotation.article_id=annotation.article_id,annotation.article=annotation.article_id,$(".annotation-editor").removeClass("discovery-sample")),$.ajax({type:method,url:url,contentType:"application/json",data:JSON.stringify(this._annotationToModel(annotation)),error:function(response,text_status,jqXHR){var ref3;return null!=(ref3=annotation.$annotation)?ref3.addClass("error"):void 0},success:function(response,text_status,jqXHR){var date,ref3,ref4,ref5;if($.extend(!0,annotation,{id:response.id,href:response.href}),null!=(ref3=annotation.$annotation)&&ref3.attr("data-id",annotation.id),null!=(ref4=annotation.$annotation)&&ref4.removeClass("error"),date=new Date,annotation.text)return null!=(ref5=annotation.$annotation)?ref5.find(".saved").text("Saved "+moment().format("LT")):void 0},complete:function(_this){return function(){var ref3,trackerData;return null!=(ref3=annotation.$annotation)&&ref3.removeClass("saving creating"),annotation.locked=!1,annotation.is_modified&&(annotation.is_modified=!1,_this.annotationUpdated(annotation)),$(".annotation-help-bar").remove(),$.ajax({type:"POST",url:window.API_BASE_URL+"/tour-event/",contentType:"application/json",data:JSON.stringify({user_id:_this.options.user.id,step:"complete",is_skipped:!1,name:"annotation_discovery"})}),trackerData={event_name:"annotation_created",event_type:"click",properties:{article:annotation.article}},"undefined"!=typeof tracker&&null!==tracker?tracker.track_user_event(trackerData):void 0}}(this)}))},NewselaStore}(Annotator.Plugin),$.fn.annotator=function(options){var args;return args=Array.prototype.slice.call(arguments,1),this.each(function(){var $el,instance,method;return $el=$(this),instance=$el.data("annotator"),instance?(method=options,method&&instance[method].apply(instance,args)):(instance=new NewselaAnnotator(this,options),$el.data("annotator",instance))})}}).call(this);