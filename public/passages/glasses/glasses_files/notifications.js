(function(){var binder_urls,go_to_level_up,go_to_student_work,go_to_teacher_review_page,group_notifications,group_objects,group_url_functions,has_active_pro_license,module;module=angular.module("notifications",["newsela-common"]),has_active_pro_license=function(user){return _.some(user.licenses,function(license){return"pro"===license.product&&license.is_active})},binder_urls={non_pro_redirect:function(school_id){return"/binder/#/binder/teacher/classrooms?school_id="+school_id},assignment:function(assignment_id){return"/binder/#/binder/teacher/assignment/"+assignment_id},level_up:function(student_id){return"/binder/#/binder/teacher/student/"+student_id}},go_to_teacher_review_page=function(notification_group){var activity_type,article_id,assignment,assignment_id,classroom_id,data,redirect_url,ref,ref1,slug,student_id,type;return data=notification_group.notifications[0].data,type=notification_group.notifications[0].type,slug=data.header.slug,student_id=data.user.student.id,article_id=data.article.id,assignment=null!=(ref=notification_group.notifications[0].assignments)?ref[0]:void 0,assignment_id=null!=assignment?assignment.id:void 0,classroom_id=(null!=assignment&&null!=(ref1=assignment.classroom)?ref1.id:void 0)||notification_group.notifications[0].classrooms[0].id,"student-quiz-submission"===type?activity_type="quiz/":"student-vocabulary-completion"===type?activity_type="vocabulary/":"student-write-response"===type&&(activity_type="write/"),redirect_url="/read/"+slug+"/id/"+article_id+"/"+activity_type+("?assignment="+assignment_id+"&classroom="+classroom_id+"&student="+student_id)},go_to_student_work=function(g,user){return go_to_teacher_review_page(g)},go_to_level_up=function(g,user){var ref,ref1,ref2,ref3,ref4,ref5,student_id;return has_active_pro_license(user)&&1===(null!=(ref=g.student_groups)?ref.length:void 0)?(student_id=null!=(ref1=g.notifications[0].data)&&null!=(ref2=ref1.user)&&null!=(ref3=ref2.student)?ref3.id:void 0,student_id||(student_id=null!=(ref4=g.notifications[0].data)&&null!=(ref5=ref4.student)?ref5.id:void 0),binder_urls.level_up(student_id)):binder_urls.non_pro_redirect(user.teacher.school.id)},group_url_functions={"student-levelupevent":go_to_level_up,"student-quiz-submission":go_to_student_work,"student-vocabulary-completion":go_to_student_work,"student-article-view":go_to_student_work,"student-classroom":function(){return"/settings/#/students/"},"student-write-response":go_to_student_work,"student-annotation":go_to_student_work,"teacher-joined":function(){return"/settings/#/faculty/"},"teacher-colleagues":function(){return"/settings/#/faculty/"}},group_objects=function(objects,group_by){var getter,group,group_key,groups,i,j,key,key_values,kv,len,len1,o,value;for(groups={},i=0,len=objects.length;i<len;i++){o=objects[i],key_values=[];for(key in group_by)getter=group_by[key],value=getter(o),key_values.push([key,value]);if(group_key=function(){var j,len1,ref,results;for(results=[],j=0,len1=key_values.length;j<len1;j++)kv=key_values[j],results.push(null!=(ref=kv[1])?ref.toString():void 0);return results}().join("|"),group=groups[group_key],null==group){for(group=groups[group_key]={},j=0,len1=key_values.length;j<len1;j++)kv=key_values[j],group[kv[0]]=kv[1];group.objects=[]}group.objects.push(o)}return function(){var results;results=[];for(group_key in groups)group=groups[group_key],results.push(group);return results}()},group_notifications=function(notifications,group_by){var group,groups,i,len;for(groups=group_objects(notifications,group_by),i=0,len=groups.length;i<len;i++)group=groups[i],group.notifications=group.objects;return groups},module.factory("Notifications",function($timeout,Notification,Stream,user_id,NOTIFICATION_POLL_RATE){var NotificationService;return new(NotificationService=function(){function NotificationService(){this.notifications=[],this.subscriptions=[],this.modified_since=null,this.timeout_promise=null,this.rate=0,this.storage_key=user_id+":notifications:3",this.user_stream=Stream.get({name:"user:"+user_id},function(_this){return function(stream){var i,len,n,ref,results;for(stream.date_last_viewed&&(stream.date_last_viewed=moment(stream.date_last_viewed),_this.set_date_read(stream.date_last_viewed)),ref=_this.notifications,results=[],i=0,len=ref.length;i<len;i++)n=ref[i],results.push(_this.enrich_notification(n));return results}}(this)),this.read_from_storage()}return NotificationService.prototype.subscribe=function(callback){return this.subscriptions.push(callback),this.start_polling(),this.user_stream.$promise.then(function(_this){return function(){return callback(_this.notifications)}}(this))},NotificationService.prototype.get_date_read=function(){var e,value;try{return value=lscache.get(this.storage_key+":date_read"),value?moment(value):null}catch(error){return e=error,null}},NotificationService.prototype.set_date_read=function(date_read){if(!(this.get_date_read()&&date_read<=this.get_date_read()))return lscache.set(this.storage_key+":date_read",date_read),date_read>this.user_stream.date_last_viewed?(this.user_stream.date_last_viewed=date_read,this.user_stream.$save()):void 0},NotificationService.prototype.start_polling=function(rate){return null==rate&&(rate=NOTIFICATION_POLL_RATE),this.user_stream.$promise.then(function(_this){return function(){if(_this.rate=rate,!_this.timeout_promise)return _this.timeout_promise=$timeout(function(){return _this.query_notifications()})}}(this))},NotificationService.prototype.stop_polling=function(){return $timeout.cancel(this.timeout_promise),this.rate=0},NotificationService.prototype.enrich_notification=function(n){var date_read;return n.date_created=moment(n.date_created),date_read=this.get_date_read(),n.is_unread=!date_read||n.date_created>date_read},NotificationService.prototype.read_from_storage=function(){var notifications;if(notifications=lscache.get(this.storage_key))return this.notifications=notifications,this.modified_since=this.notifications[0].date_created},NotificationService.prototype.write_notifications_to_storage=function(iteration){var bound,e;null==iteration&&(iteration=0);try{return lscache.set(this.storage_key,this.notifications)}catch(error){if(e=error,/quota/i.test(e.name)&&("undefined"!=typeof console&&null!==console&&console.warn("Notifications exceeded localStorage quota.",this.notifications.length),iteration<10))return bound=Math.floor(this.notifications.length/2),this.notifications=this.notifications.slice(0,+bound+1||9e9),this.write_notifications_to_storage(iteration+1)}},NotificationService.prototype.mark_read=function(notifications){var date_read,i,len,n;for(null==notifications&&(notifications=this.notifications),date_read=this.get_date_read(),i=0,len=notifications.length;i<len;i++)n=notifications[i],n.is_unread&&(delete n.is_unread,n.date_created>date_read&&(date_read=n.date_created));if(date_read)return this.set_date_read(date_read)},NotificationService.prototype.query_notifications=function(){return ifvisible.now()?Notification.query({stream:this.user_stream.name,modified_since:this.modified_since},function(_this){return function(notifications){var callback,i,j,len,len1,n,ref;if(notifications.length){for(_this.notifications=notifications.concat(_this.notifications),_this.modified_since=notifications[0].date_created,i=0,len=notifications.length;i<len;i++)n=notifications[i],_this.enrich_notification(n);for(_this.write_notifications_to_storage(),ref=_this.subscriptions,j=0,len1=ref.length;j<len1;j++)(callback=ref[j])(notifications)}if(_this.rate)return _this.timeout_promise=$timeout(function(){return _this.query_notifications()},1e3*_this.rate)}}(this)):void(this.timeout_promise=$timeout(function(_this){return function(){return _this.query_notifications()}}(this),1e3))},NotificationService}())}),module.directive("notificationStream",function(){return{templateUrl:"notifications/stream.html",controller:function($scope,$timeout,isProUser,StudySegment,User,Notifications,STATIC_URL,BINDER_REDESIGN_URL){var notifications,on_new_notifications,user;return $scope.is_loading=!0,$scope.STATIC_URL=STATIC_URL,user=null,notifications=[],on_new_notifications=function(new_notifications){var day,days,group_by,i,j,k,l,len,len1,len2,len3,n,ref,ref1,ref2,type_group;for(notifications=notifications.concat(function(){var i,len,results;for(results=[],i=0,len=new_notifications.length;i<len;i++)n=new_notifications[i],group_url_functions[n.type]&&results.push(n);return results}()),days=group_notifications(notifications,{date:function(n){return n.date_created.clone().startOf("day")}}),days.sort(function(ga,gb){return gb.date-ga.date}),group_by={type:function(n){return n.type},verb:function(n){return n.verb},object:function(n){return n.object},assignment:function(n){var ref,ref1;return null!=(ref=n.data)&&null!=(ref1=ref.assignment)?ref1.id:void 0},classroom:function(n){var ref,ref1;return null!=(ref=n.data)&&null!=(ref1=ref.classroom)?ref1.id:void 0},header:function(n){var ref,ref1;return null!=(ref=n.data)&&null!=(ref1=ref.header)?ref1.id:void 0},level_up_id:function(n){return"student-levelupevent"===n.type?n.id:null}},$scope.can_see_student_names&&(group_by.write_response_id=function(n){var ref,ref1;return null!=(ref=n.data)&&null!=(ref1=ref.response)?ref1.id:void 0},group_by.annotation_article_student_id=function(n){var article_id,ref,ref1,student_id;return"student-annotation"===n.type?(article_id=null!=(ref=n.data)?ref.article.id:void 0,student_id=null!=(ref1=n.data)?ref1.user.student.id:void 0,article_id+":"+student_id):""}),i=0,len=days.length;i<len;i++)for(day=days[i],day.type_groups=group_notifications(day.notifications,group_by),day.type_groups.sort(function(ga,gb){var na,nb;return na=ga.notifications[ga.notifications.length-1],nb=gb.notifications[gb.notifications.length-1],nb.date_created-na.date_created}),ref=day.type_groups,j=0,len1=ref.length;j<len1;j++)if(type_group=ref[j],type_group.student_groups=group_notifications(type_group.notifications,{user_id:function(n){var ref1,ref2;return null!=(ref1=n.data)&&null!=(ref2=ref1.user)?ref2.id:void 0},subject:function(n){return n.subject},subject_modifier:function(n){return n.subject_modifier},subject_type:function(n){return n.subject_type?n.subject_type:"student"}}),1!==type_group.student_groups.length)if("teacher-colleagues"===type_group.notifications[0].type)for(ref1=type_group.notifications,k=0,len2=ref1.length;k<len2;k++)n=ref1[k],n.verb=n.verb.replace(/\bis\b/,"are");else if("teacher-joined"===type_group.notifications[0].type)for(ref2=type_group.notifications,l=0,len3=ref2.length;l<len3;l++)n=ref2[l],n.subject_modifier="Your colleagues";return $scope.days=days,$scope.is_loading=!1},user=User.get({id:"me"},function(user){return null!=user.student?$scope.can_see_student_names=!0:($scope.can_see_student_names=isProUser(user),$scope.can_see_student_names||$scope.$watch(function(){return isProUser(user)},function(){return $scope.can_see_student_names=isProUser(user),on_new_notifications([])})),Notifications.subscribe(on_new_notifications)}),angular.extend($scope,{is_group_unread:function(group){var i,len,n,ref;for(ref=group.notifications,i=0,len=ref.length;i<len;i++)if(n=ref[i],n.is_unread)return!0;return!1},notification_group_click:function(group,day_index,group_index,index){var kinesis_data;return kinesis_data={user_id:$scope.user.id,date_created:moment.utc().format("YYYY-MM-DD HH:mm:ss"),event_name:"masthead_btn_click",event_type:"click",properties:{event_description:"binder-masthead-notification"}},"undefined"!=typeof tracker&&null!==tracker&&tracker.send_to_kinesis("user-events",kinesis_data),document.location.href=group_url_functions[group.type](group,user)}})}}})}).call(this);