(function(){var mastheadSearchModule,module;module=angular.module("masthead",["newsela-common","notifications"]),module.config(["$locationProvider",function($locationProvider){if(window.is_react_page)return $locationProvider.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}]),module.controller("mastheadNavigation",function($location,$scope,$timeout,$window,ContentSearch,TourEvent,User,isXsScreen,STATIC_URL,hasActiveProSubscription,hasActiveCustomUnitsLicense,StudySegment,hasExpiredWithin90Days,willExpireWithin30Days){var get_custom_collections_for_user,notification_tour,send_to_ga,send_to_kinesis,set_custom_collections_for_district_title,set_custom_collections_for_school_title;return set_custom_collections_for_district_title=function(user){var ref,ref1;return(null!=(ref=user.district_leader)&&null!=(ref1=ref.district)?ref1.name:void 0)?$scope.custom_collections_district_title="Collections for "+user.district_leader.district.name:$scope.custom_collections_district_title="Collections for Your District",$scope.show_custom_collections_for_district=!0},set_custom_collections_for_school_title=function(user){var ref,ref1;return(null!=(ref=user.teacher)&&null!=(ref1=ref.school)?ref1.name:void 0)?$scope.custom_collections_school_title="Collections for "+user.teacher.school.name:user.district_leader?$scope.custom_collections_school_title="Collections for Your Schools":$scope.custom_collections_school_title="Collections for Your School",$scope.show_custom_collections_for_school=!0},get_custom_collections_for_user=function(user){var district_params,school_params;if(hasActiveCustomUnitsLicense(user))return district_params={tiles:!0,page_size:1,type:"text_set",text_set_type:"unit",rule:"units-for-your-district"},ContentSearch.get(district_params).$promise.then(function(response){if(response.tiles.length>0)return set_custom_collections_for_district_title(user)}),school_params=district_params,school_params.rule="units-for-your-school",ContentSearch.get(school_params).$promise.then(function(response){if(response.tiles.length>0)return set_custom_collections_for_school_title(user)})},notification_tour=function(tour_name){var step,tour_event;return!isXsScreen()&&(!lscache.get("masthead_notification_shown_recently")&&(tour_event=_.get($scope.user.tour_events,tour_name,{is_skipped:!1,step:1}),step=Number(tour_event.step),!isNaN(step)&&(lscache.set("masthead_notification_shown_recently",!0,360),$scope["show_"+tour_name]=!0,TourEvent.save({name:tour_name,step:"complete"}),!0)))},$scope.STATIC_URL=STATIC_URL,$scope.user=User.me(),$scope.user.$promise.then(function(user){var show_power_words_notification;if(user.is_authenticated&&(user.teacher&&hasActiveProSubscription(user)&&$scope.trackElevioFailedToLoad(),user.teacher&&get_custom_collections_for_user(user),"/"===$location.path()))return show_power_words_notification=angular.element("#masthead .power-words-link").length&&!$location.path().match(/\/power-words\/?$/)&&user.id%25!==1,show_power_words_notification?notification_tour("power_words_nav"):void 0}),$scope.track_keep_pro=function(){var kinesis_data,u;$scope.user&&(u=$scope.user,(willExpireWithin30Days(u)||hasExpiredWithin90Days(u))&&(kinesis_data={user_id:$scope.user.id,date_created:moment.utc().format("YYYY-MM-DD HH:mm:ss"),event_name:"keep_pro_settings_masthead_dropdown",event_type:"click",properties:{source_url:$location.absUrl(),event_description:"Clicked Keep Pro on the settings dropdown"}},"undefined"!=typeof tracker&&null!==tracker&&tracker.send_to_kinesis("user-events",kinesis_data)))},$scope.openHelp=function($event){var ref;return $event.preventDefault(),$scope.track_click("Help Icon Clicked"),_.isFunction(null!=(ref=$window._elev)?ref.openHome:void 0)?($event.stopPropagation(),$window._elev.openHome()):($window.open("/support/sso","_blank"),!0)},$scope.openSigninModal=function($event){var modalEvent;return $event.preventDefault(),$scope.track_click("Sign In Clicked"),modalEvent=document.createEvent("Event"),modalEvent.initEvent("openSignInModal",!0,!0),window.dispatchEvent(modalEvent)},$scope.go_to_binder=function(event){if(send_to_kinesis({event_description:"binder-masthead-click"}),$scope.show_power_words_notification)return event.preventDefault(),event.stopImmediatePropagation(),$window.location="/pro-binder/power-words"},$scope.send_google_analytics_pageview=function(virtual_page){return"function"==typeof ga?ga("send","pageview","/vpv/"+virtual_page):void 0},send_to_kinesis=function(properties){var kinesis_data;return properties.source_url=$location.absUrl(),kinesis_data={user_id:$scope.user.id,date_created:moment.utc().format("YYYY-MM-DD HH:mm:ss"),event_name:"masthead_btn_click",event_type:"click",properties:properties},"undefined"!=typeof tracker&&null!==tracker?tracker.send_to_kinesis("user-events",kinesis_data):void 0},send_to_ga=function(event_description){return"function"==typeof ga?ga("send","event","button","click",event_description):void 0},$scope.track_click=function(event_description,properties){return properties||(properties={}),properties.event_description=event_description,send_to_kinesis(properties),send_to_ga(event_description)},$scope.open_onboarding_dialog=function(){var onboardingEvent;return onboardingEvent=document.createEvent("Event"),onboardingEvent.initEvent("openOnboardingDialog",!1,!0),window.dispatchEvent(onboardingEvent)},$scope.trackElevioFailedToLoad=function(){var CACHE_KEY,TIME;if(CACHE_KEY="elevio_status",TIME=1e4,!$window.localStorage.getItem(CACHE_KEY))return setTimeout(function(){var kinesis_data,properties,ref;return(null!=(ref=$window._elev)?ref.openHome:void 0)?$window.localStorage.setItem(CACHE_KEY,"OK"):(properties={source_url:$location.absUrl(),event_description:"Elevio Blocked By Firewall"},kinesis_data={user_id:$scope.user.id,date_created:moment.utc().format("YYYY-MM-DD HH:mm:ss"),event_name:"blocked_elevio_url",event_type:"error",properties:properties},"undefined"!=typeof tracker&&null!==tracker&&tracker.send_to_kinesis("user-events",kinesis_data),$window.localStorage.setItem(CACHE_KEY,"FAIL"))},TIME)}}),module.controller("libraryNavigation",function($scope,$httpParamSerializer,$timeout,$element,ContentSearch){var current_querystring,preview_promise,show;return current_querystring=null,show=function(filters,label){var headers,next_querystring;if(next_querystring=$httpParamSerializer(filters),current_querystring!==next_querystring)return current_querystring=next_querystring,$scope.preview_filters=filters,filters.page_size=4,filters.tiles=!0,filters.story_type=filters.feature?null:filters.story_type?filters.story_type:["information","biography","fiction"],headers=ContentSearch.query(filters),headers.$promise.then(function(){if(current_querystring===next_querystring)return $scope.headers=headers,$scope.label=label})},angular.extend($scope,$scope.preview_filters=null),preview_promise=null,$scope.show_initial_preview=function(){if(!$scope.preview_filters)return show({subject:"arts-and-culture"},"Latest In Arts & Culture")},$scope.show_preview=function(filters,label){if(preview_promise&&$timeout.cancel(preview_promise),$element.find("aside:visible").length)return $timeout(function(){return show(filters,label)},100)}}),module.controller("newsNavigation",function($scope,$httpParamSerializer,$timeout,$element,ContentSearch){var current_querystring,preview_promise,show;return current_querystring=null,show=function(filters,label){var headers,next_querystring;if(next_querystring=$httpParamSerializer(filters),current_querystring!==next_querystring)return current_querystring=next_querystring,$scope.preview_filters=filters,filters.page_size=4,filters.tiles=!0,filters.story_type=filters.feature?null:filters.story_type?filters.story_type:["news","editorial"],headers=ContentSearch.query(filters),headers.$promise.then(function(){if(current_querystring===next_querystring)return $scope.headers=headers,$scope.label=label})},angular.extend($scope,$scope.preview_filters=null),preview_promise=null,$scope.show_initial_preview=function(){if(!$scope.preview_filters)return show({category:"opinion"},"Latest In Opinion")},$scope.show_preview=function(filters,label){if(preview_promise&&$timeout.cancel(preview_promise),$element.find("aside:visible").length)return $timeout(function(){return show(filters,label)},100)}}),module.controller("textSetNavigation",function($scope,$httpParamSerializer,$timeout,$element,TextSet){var preview_promise,show;return show=function(filters,label){var current_querystring,next_querystring,text_sets;if(next_querystring=$httpParamSerializer(filters),current_querystring!==next_querystring)return current_querystring=next_querystring,$scope.preview_filters=filters,filters.page_size=4,filters.include_article_headers=!0,filters.include_likes=!0,filters.include_user_likes=!0,text_sets=TextSet.query(filters),text_sets.$promise.then(function(){if(current_querystring===next_querystring)return $scope.text_sets=text_sets,$scope.label=label})},preview_promise=null,$scope.show_initial_preview=function(){if(!$scope.preview_filters)return show({ids:"330162,158454,207988,331983"},"Featured Text Sets")},$scope.show_preview=function(filters,label){if(preview_promise&&$timeout.cancel(preview_promise),$element.find("aside:visible").length)return $timeout(function(){return show(filters,label)},100)}}),module.controller("unitsNavigation",function($scope,$httpParamSerializer,$timeout,$element,ContentSearch){var preview_promise,show;return show=function(filters,label){var current_querystring,next_querystring,results;if(next_querystring={type:"text_set",page_size:4,tiles:!0,text_set_type:"unit"},filters.subject?next_querystring.subject=filters.subject:filters.rule&&(next_querystring.rule=filters.rule),current_querystring!==next_querystring)return current_querystring=next_querystring,results=ContentSearch.query(current_querystring),results.$promise.then(function(){if(current_querystring===next_querystring)return $scope.results=results,$scope.label=label})},preview_promise=null,$scope.show_initial_preview=function(){if(!$scope.preview_filters)return show({subject:"unit:us-history"},"U.S. History")},$scope.show_preview=function(filters,label){if(preview_promise&&$timeout.cancel(preview_promise),$element.find("aside:visible").length)return $timeout(function(){return show(filters,label)},100)}}),module.directive("expandableXs",function(isXsScreen){return{link:function(scope,element){return element.children("a").on("click",function(e){if(element.siblings().removeClass("open"),element.siblings().find("i.fa-chevron-up").removeClass("fa-chevron-up").addClass("fa-chevron-down"),isXsScreen())return e.preventDefault(),e.stopImmediatePropagation(),element.toggleClass("open"),$(this).find("i").toggleClass("fa-chevron-down fa-chevron-up")})}}}),module.directive("openableNav",function($timeout,isXsScreen){return{link:function(scope,element){return element.children("li").each(function(){var li,timeout_promise;return li=angular.element(this),timeout_promise=null,li.on("mouseenter",function(){if(!isXsScreen())return timeout_promise=$timeout(function(){return li.addClass("open"),scope.$broadcast("nav-opened",{element:li})},75)}),li.on("mouseleave",function(){if(!isXsScreen())return $timeout.cancel(timeout_promise),li.removeClass("open"),scope.$broadcast("nav-closed",{element:li})})})}}}),module.directive("notificationCounter",function(Notifications){return{scope:{},template:'<span ng-if="new_notification_count" class="notification-pill">\n  {{new_notification_count}}\n</span>',controller:function($scope,$window){return $scope.new_notification_count=0,Notifications.subscribe(function(notifications){var i,len,n,results1;for(results1=[],i=0,len=notifications.length;i<len;i++)n=notifications[i],n.is_unread?results1.push($scope.new_notification_count+=1):results1.push(void 0);return results1}),$scope.$watch("new_notification_count",function(count){var original_title;return original_title=$window.document.title.replace(/^\(\d+\) /,""),count?$window.document.title="("+count+") "+original_title:$window.document.title=original_title})},link:function(scope,element){var hover_start;return hover_start=null,element.closest(".mark-notifications-read").on("mouseenter",function(){return hover_start=moment()}),element.closest(".mark-notifications-read").on("mouseleave",function(){return scope.new_notification_count=0,Notifications.mark_read(),scope.$apply()})}}}),mastheadSearchModule=angular.module("masthead-search",["newsela-common","newsela-search-base","ngAnimate"]),mastheadSearchModule.config(["$locationProvider",function($locationProvider){if(window.is_react_page)return $locationProvider.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}]),mastheadSearchModule.controller("MastheadSearchController",function($controller,$location,$scope){var is_advanced_search,is_empty,send_to_ga,send_to_kinesis;return is_advanced_search=$("#advanced-search").length>0,angular.extend(this,$controller("BaseSearchController",{$scope:$scope,Searches:null,Filters:null,IsInsetSearch:!is_advanced_search,SkipSearches:is_advanced_search})),$scope.suggested_searches=["Pro/Con","George Washington","Animals","Basketball","Trump","Technology","Space","China","Protests"],$scope.select_suggested_search=function(suggestion){$scope.toggle_filter("needle",suggestion)},$scope.show_suggested_terms=function(){var key,ref,value;ref=$scope.filters;for(key in ref)if(value=ref[key],!is_empty(value))return!1;return!0},is_empty=function(value){return angular.isArray(value)&&0===value.length||"string"==typeof value&&0===value.length||null==value},send_to_kinesis=function(properties){var kinesis_data;return properties.source_url=$location.absUrl(),kinesis_data={user_id:$scope.user.id,date_created:moment.utc().format("YYYY-MM-DD HH:mm:ss"),event_name:"inset_search",event_type:"click",properties:properties},"undefined"!=typeof tracker&&null!==tracker?tracker.send_to_kinesis("user-events",kinesis_data):void 0},send_to_ga=function(event_description){return"function"==typeof ga?ga("send","event","inset_search","click",event_description):void 0},$scope.track_click=function(event_description,properties){return properties||(properties={}),properties.event_description=event_description,send_to_kinesis(properties),send_to_ga(event_description)}})}).call(this);