(function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;Annotator.Plugin.Touch=function(superClass){function Touch(element,options){this._onDocumentTap=bind(this._onDocumentTap,this),this._onHighlightTap=bind(this._onHighlightTap,this),this._onSelection=bind(this._onSelection,this),this._watchForSelection=bind(this._watchForSelection,this),Touch.__super__.constructor.apply(this,arguments),this.utils=Annotator.Plugin.Touch.utils,this.selection=null,this.document=jQuery(document)}var _t,jQuery;return extend(Touch,superClass),_t=Annotator._t,jQuery=Annotator.$,Touch.states={ON:"on",OFF:"off"},Touch.prototype.options={force:!1,useHighlighter:!1},Touch.prototype.pluginInit=function(){if(Annotator.supported()&&(this.options.force||Touch.enableTouch()))return $(this.options.container).addClass("touch"),this.toggle=Touch.states.OFF,this.options.useHighlighter&&(this.highlighter=new Highlighter({root:this.element[0],prefix:"annotator-selection",enable:!1,highlightStyles:!0})),this.subscribe("selection",this._onSelection),this._watchForSelection()},Touch.prototype.pluginDestroy=function(){if(this.highlighter)return this.highlighter.disable()},Touch.prototype.startAnnotating=function(){return this.highlighter&&this.highlighter.enable(),this.toggle=Touch.states.ON,this},Touch.prototype.stopAnnotating=function(){return this.highlighter&&this.highlighter.disable(),this.toggle=Touch.states.OFF,this},Touch.prototype.isAnnotating=function(){var usingHighlighter;return usingHighlighter=this.options.useHighlighter,!usingHighlighter||this.toggle===Touch.states.ON},Touch.prototype._watchForSelection=function(){var interval,start,step;if(!this.timer)return interval=Touch.isAndroid()?300:1e3/60,start=(new Date).getTime(),(step=function(_this){return function(){var progress;return progress=(new Date).getTime()-start,progress>interval&&(start=(new Date).getTime(),_this._checkSelection()),_this.timer=_this.utils.requestAnimationFrame.call(window,step)}}(this))()},Touch.prototype._clearWatchForSelection=function(){return this.utils.cancelAnimationFrame.call(window,this.timer),this.timer=null},Touch.prototype._checkSelection=function(){var previous,selection,string;selection=window.getSelection(),previous=this.selectionString,string=jQuery.trim(selection+""),selection.rangeCount&&string!==this.selectionString&&(this.range=selection.getRangeAt(0),this.selectionString=string,this.startAnnotating()),(0===selection.rangeCount||this.range&&this.range.collapsed)&&(this.range=null,this.selectionString="",this.stopAnnotating());try{if(this.selectionString!==previous)return this.publish("selection",[this.range,this])}catch(error){}},Touch.prototype._onSelection=function(){var browserRange,onAnnotationCreated,range;if(this.isAnnotating&&this.range&&this._isValidSelection(this.range))return browserRange=new Annotator.Range.BrowserRange(this.range),range=browserRange.normalize().limit(this.element[0]),range&&!this.annotator.isAnnotator(range.commonAncestor)&&(onAnnotationCreated=function(_this){return function(annotation){return _this.annotator.unsubscribe("beforeAnnotationCreated",onAnnotationCreated),annotation.quote=range.toString(),annotation.ranges=[range]}}(this),this.annotator.subscribe("beforeAnnotationCreated",onAnnotationCreated)),this.publish("selectionCreated",[new Array(range)])},Touch.prototype._isValidSelection=function(range){var inElement,isStartOffsetValid,isValidEnd,isValidStart;return inElement=function(node){return jQuery(node).parents(".annotator-wrapper").length},isStartOffsetValid=range.startOffset<range.startContainer.length,isValidStart=isStartOffsetValid&&inElement(range.startContainer),isValidEnd=range.endOffset>0&&inElement(range.endContainer),isValidStart||isValidEnd},Touch.prototype._onHighlightTap=function(event){if(this.publish("onHighlightTap",event),event.stopPropagation(),jQuery.contains(this.element[0],event.currentTarget))return this.document.unbind("tap",this._onDocumentTap),this.document.bind("tap",{preventDefault:!1},this._onDocumentTap)},Touch.prototype._onDocumentTap=function(event){if(this.annotator.isAnnotator(event.target)||this.annotator.viewer.hide(),!this.annotator.viewer.isShown())return this.document.unbind("tap",this._onDocumentTap)},Touch.enableTouch=function(){var isIpad,isIphone;return isIpad=/iPad/i.test(window.navigator.userAgent),isIphone=/iPhone/i.test(window.navigator.userAgent),isIpad||isIphone||this.isAndroid()},Touch.isAndroid=function(){return/Android/i.test(window.navigator.userAgent)},Touch}(Annotator.Plugin),jQuery.event.special.tap={add:function(eventHandler){var context,data,onTapEnd,onTapStart;return data=eventHandler.data=eventHandler.data||{},context=this,onTapStart=function(event){return data.preventDefault!==!1&&event.preventDefault(),data.onTapDown&&data.onTapDown.apply(this,arguments),data.event=event,data.touched=setTimeout(function(){return data.touched=null},data.timeout||30),jQuery(document).bind({touchend:onTapEnd,mouseup:onTapEnd})},onTapEnd=function(event){var handler;return null!=data.touched&&(clearTimeout(data.touched),(event.target===context||jQuery.contains(context,event.target))&&(handler=eventHandler.origHandler||eventHandler.handler,handler.call(this,data.event)),data.touched=null),data.onTapUp&&data.onTapUp.apply(this,arguments),jQuery(document).unbind({touchstart:onTapEnd,mousedown:onTapEnd})},data.tapHandlers={touchstart:onTapStart,mousedown:onTapStart},eventHandler.selector?jQuery(context).delegate(eventHandler.selector,data.tapHandlers):jQuery(context).bind(data.tapHandlers)},remove:function(eventHandler){return jQuery(this).unbind(eventHandler.data.tapHandlers)}},Annotator.Delegator.natives.push("touchstart","touchmove","touchend","tap"),Annotator.Plugin.Touch.utils=function(){var cancelAnimationFrame,i,lastTime,len,prefix,requestAnimationFrame,vendors;for(vendors=["ms","moz","webkit","o"],requestAnimationFrame=window.requestAnimationFrame,cancelAnimationFrame=window.cancelAnimationFrame,i=0,len=vendors.length;i<len;i++)prefix=vendors[i],requestAnimationFrame||(requestAnimationFrame=window[prefix+"RequestAnimationFrame"],cancelAnimationFrame=window[prefix+"CancelAnimationFrame"]||window[prefix+"CancelRequestAnimationFrame"]);return requestAnimationFrame||(lastTime=0,requestAnimationFrame=function(callback,element){var currTime,timeToCall;return currTime=(new Date).getTime(),timeToCall=Math.max(0,16-(currTime-lastTime)),lastTime=currTime+timeToCall,window.setTimeout(function(){return callback(currTime+timeToCall)},timeToCall)}),cancelAnimationFrame||(cancelAnimationFrame=function(id){return clearTimeout(id)}),{requestAnimationFrame:requestAnimationFrame,cancelAnimationFrame:cancelAnimationFrame,nextTick:function(fn){return setTimeout(fn,0)}}}()}).call(this);